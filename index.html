<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>gem-studio/anyGem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* GitHub ç³»çµ±å­—é«” */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeInUp 0.3s ease-out forwards; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; border: 2px solid #0d1117; }
        ::-webkit-scrollbar-thumb:hover { background: #8b949e; }
        
        .preview-active { display: flex; opacity: 1; padding: 0.5rem; border-bottom: 1px solid #30363d; }
        .preview-hidden { display: none; opacity: 0; }
        
        /* è‡ªè¨‚ Segment Control æ¨£å¼ */
        .engine-radio:checked + div {
            background-color: #21262d;
            border-color: #8b949e;
            color: #c9d1d9;
        }
    </style>
</head>
<body class="bg-[#0d1117] text-[#c9d1d9] h-screen flex flex-col overflow-hidden">

    <!-- GitHub Style Header -->
    <header class="bg-[#161b22] border-b border-[#21262d] py-3 px-4 flex flex-col md:flex-row md:items-center justify-between z-50 shadow-sm">
        <div class="flex items-center gap-2 mb-3 md:mb-0">
            <!-- GitHub Logo Vector -->
            <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" class="fill-[#c9d1d9]"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.46-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg>
            <div class="ml-2 text-lg">
                <span class="text-[#58a6ff] hover:underline cursor-pointer">gem-studio</span>
                <span class="text-[#8b949e] mx-1">/</span>
                <span class="text-[#c9d1d9] font-bold hover:underline cursor-pointer">anyGem</span>
            </div>
            <span class="border border-[#30363d] rounded-full px-2 py-0.5 text-[12px] text-[#8b949e] ml-2 font-medium">å…¬é–‹</span>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- Mode Select -->
            <select id="mode-select" class="bg-[#21262d] hover:bg-[#30363d] text-[#c9d1d9] text-sm py-1.5 px-3 rounded-md border border-[#30363d] outline-none font-medium cursor-pointer transition-colors appearance-none pr-8 relative" style="background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23c9d1d9%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto;">
                <option value="t2i">ğŸ¨ æ–‡å­—ç”Ÿåœ–</option>
                <option value="i2i">ğŸ–¼ï¸ åœ–ç‰‡ç·¨è¼¯</option>
            </select>
            
            <!-- Quality Segmented Control -->
            <div class="flex bg-[#0d1117] border border-[#30363d] rounded-md p-[2px]">
                <label class="cursor-pointer">
                    <input type="radio" name="quality" value="fast" class="engine-radio hidden" checked>
                    <div class="px-3 py-1 rounded-md text-xs font-medium text-[#8b949e] hover:text-[#c9d1d9] transition-colors">
                        âš¡ è‰ç¨¿
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="quality" value="high" class="engine-radio hidden">
                    <div class="px-3 py-1 rounded-md text-xs font-medium text-[#8b949e] hover:text-[#c9d1d9] transition-colors">
                        ğŸ’ å¤§å¸«
                    </div>
                </label>
            </div>
        </div>
    </header>

    <!-- Main Chat/Timeline Area -->
    <main id="chat-window" class="flex-grow p-4 md:p-6 overflow-y-auto space-y-6 scroll-smooth w-full"></main>

    <!-- Input Footer (GitHub Comment Box Style) -->
    <footer class="p-4 bg-[#0d1117] border-t border-[#21262d] z-50">
        <div class="max-w-4xl mx-auto flex gap-3">
            <!-- User Avatar -->
            <div class="hidden md:flex flex-shrink-0 mt-1">
                <div class="w-10 h-10 rounded-full bg-[#238636] flex items-center justify-center text-white font-bold text-lg shadow-sm">U</div>
            </div>
            
            <!-- Comment Box -->
            <div class="flex-grow border border-[#30363d] rounded-md bg-[#0d1117] flex flex-col relative focus-within:border-[#58a6ff] focus-within:ring-1 focus-within:ring-[#58a6ff] transition-all">
                
                <!-- Prompt Helper Popover Panel (Hidden by default) -->
                <div id="prompt-helper-panel" class="hidden absolute bottom-full left-0 mb-2 w-full sm:w-[500px] bg-[#161b22] border border-[#30363d] rounded-md shadow-2xl z-50 flex-col overflow-hidden text-sm animate-fade-in">
                    <div class="px-3 py-2 bg-[#0d1117] border-b border-[#30363d] flex justify-between items-center">
                        <span class="font-bold text-[#c9d1d9] flex items-center gap-2">
                            <svg aria-hidden="true" height="14" viewBox="0 0 16 16" version="1.1" width="14" class="fill-[#8b949e]"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.75 1.75 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>
                            ç”Ÿåœ–é¢¨æ ¼æç¤ºè© (Prompt Tags)
                        </span>
                        <button onclick="togglePromptHelper()" class="text-[#8b949e] hover:text-[#c9d1d9] p-1 rounded-md hover:bg-[#30363d] transition-colors">âœ•</button>
                    </div>
                    <div class="p-3 max-h-[250px] overflow-y-auto space-y-4" id="style-categories">
                        <!-- Style categories will be injected here via JS -->
                    </div>
                </div>

                <!-- Tab Header -->
                <div class="bg-[#161b22] border-b border-[#30363d] px-2 pt-2 flex gap-1 rounded-t-md">
                    <div class="px-4 py-2 text-[#c9d1d9] border border-[#30363d] border-b-transparent bg-[#0d1117] rounded-t-md text-sm font-medium -mb-px z-10">æ’°å¯«</div>
                    <div class="px-4 py-2 text-[#8b949e] hover:text-[#c9d1d9] text-sm font-medium cursor-not-allowed">é è¦½</div>
                </div>

                <!-- Preview Area (Hidden by default) -->
                <div id="upload-preview-container" class="preview-hidden bg-[#0d1117] items-center gap-3">
                    <div class="relative inline-block border border-[#30363d] rounded-md p-1 bg-[#161b22]">
                        <img id="upload-thumbnail" class="h-16 w-16 object-cover rounded-sm">
                        <button onclick="clearUpload()" class="absolute -top-2 -right-2 bg-[#da3633] text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hover:bg-[#b62324] shadow-md border border-[#0d1117]">âœ•</button>
                    </div>
                    <div class="text-xs text-[#8b949e]">
                        <span class="text-[#c9d1d9] font-medium">å·²é™„åŠ åœ–ç‰‡ã€‚</span> æ¨¡å¼å·²è‡ªå‹•åˆ‡æ›ç‚º <span class="border border-[#30363d] rounded px-1 text-[#c9d1d9]">åœ–ç‰‡ç·¨è¼¯</span>ã€‚
                    </div>
                </div>

                <!-- Textarea -->
                <div class="p-2 bg-[#0d1117]">
                    <textarea id="user-input" class="w-full bg-[#0d1117] text-[#c9d1d9] outline-none resize-none p-2 min-h-[80px] text-sm placeholder-[#8b949e]" placeholder="ç•™è¨€æˆ–æè¿°æ‚¨æƒ³è¦çš„åœ–ç‰‡..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleSend(); }"></textarea>
                </div>

                <!-- Footer Actions -->
                <div class="flex justify-between items-center p-2 bg-[#161b22] rounded-b-md">
                    <div class="flex gap-1">
                        <input type="file" id="file-upload" class="hidden" accept="image/jpeg, image/png, image/webp">
                        <button onclick="document.getElementById('file-upload').click()" class="text-[#8b949e] hover:text-[#58a6ff] p-2 rounded-md transition-colors hover:bg-[#30363d]" title="é™„åŠ åœ–ç‰‡">
                            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" class="fill-current"><path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5h-3.32Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path></svg>
                        </button>
                        <!-- Style Prompt Tool Button -->
                        <button onclick="togglePromptHelper()" type="button" class="text-[#8b949e] hover:text-[#e3b341] p-2 rounded-md transition-colors hover:bg-[#30363d]" title="é¢¨æ ¼æç¤ºè©å·¥å…·">
                            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" class="fill-current"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.75 1.75 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>
                        </button>
                    </div>
                    
                    <button onclick="handleSend()" id="send-btn" class="bg-[#238636] hover:bg-[#2ea043] text-white px-4 py-1.5 rounded-md font-medium border border-[rgba(240,246,252,0.1)] text-sm transition-colors flex items-center gap-2">
                        <span>ç”Ÿæˆ</span>
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const input = document.getElementById('user-input');
        const btn = document.getElementById('send-btn');
        const modeSelect = document.getElementById('mode-select');
        const fileInput = document.getElementById('file-upload');
        const previewContainer = document.getElementById('upload-preview-container');
        const thumbnail = document.getElementById('upload-thumbnail');
        
        // ç¶å®šå°ˆå±¬çš„ GAS å¾Œç«¯ API ç¶²å€
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyZ8ONPSxl0k5ZybOItosDbeCyb0P4Nb_xgcNlh3izSjrV-V11Y6lUMEkqs4JzZMjWhsg/exec";
        
        // å‰ç«¯æŒ‡å®šçš„æ¨¡å‹æ¸…å–® (ä¿®æ­£å¤§å¸«æ¨¡å¼è¨­å®š)
        const MODELS = {
            t2i: {
                fast: "imagen-4.0-fast-generate-001",
                high: "imagen-4.0-ultra-generate-001" // æ–‡å­—ç”Ÿåœ–å¤§å¸«æ¨¡å¼
            },
            i2i: {
                fast: "gemini-2.5-flash-image",
                high: "nano-banana-pro-preview" // åœ–ç‰‡ç·¨è¼¯å¤§å¸«æ¨¡å¼
            }
        };

        let activeFile = null;
        let currentAbortController = null; // å®£å‘Šä¸­æ–·æ§åˆ¶å™¨è®Šæ•¸

        // --- æ­·å²ç´€éŒ„èˆ‡ä¸Šä¸‹æ–‡ç®¡ç† (æ”¯æ´ 5 å‰‡å°è©±è¨˜æ†¶) ---
        let conversationHistory = []; 
        const MAX_HISTORY_LENGTH = 5 * 2; // 5æ¬¡ä¾†å› (ä¸€å•ä¸€ç­”å…± 10 ç­†)
        let lastGeneratedImage = null;
        let lastGeneratedMime = null;

        // --- é¢¨æ ¼æç¤ºè©å·¥å…·é‚è¼¯é–‹å§‹ ---
        const styleData = [
            {
                category: "ğŸ¨ è—è¡“é¢¨æ ¼ (Art Style)",
                items: ["è³½åšé¾å…‹ (Cyberpunk)", "å‰åœåŠ›å‹•ç•«é¢¨æ ¼ (Ghibli Studio)", "å¯«å¯¦æ”å½± (Photorealistic)", "æ–°æµ·èª é¢¨æ ¼ (Makoto Shinkai)", "å¾©å¤åƒç´ è—è¡“ (Pixel Art)", "åšå¡—æ°´å½© (Watercolor)", "3D è¾›çƒ·å€¼æ¸²æŸ“ (Octane Render)", "æ¥µç°¡ä¸»ç¾© (Minimalism)"]
            },
            {
                category: "ğŸ’¡ å…‰å½±æ¸²æŸ“ (Lighting)",
                items: ["é›»å½±ç´šå…‰å½± (Cinematic Lighting)", "éœ“è™¹ç‡ˆå…‰ (Neon Lights)", "ä¸é”çˆ¾æ•ˆæ‡‰/é«”ç©å…‰ (Volumetric Lighting)", "é»ƒé‡‘æ™‚åˆ» (Golden Hour)", "æŸ”å’Œæ¼«åå°„ (Soft Illumination)"]
            },
            {
                category: "ğŸ“· é¡é ­èˆ‡è¦–è§’ (Camera)",
                items: ["å¾®è·ç‰¹å¯« (Macro Shot)", "è¶…å»£è§’ (Ultra-Wide Angle)", "é³¥ç°è¦–è§’ (Bird's-Eye View)", "æ™¯æ·±æ¨¡ç³Š (Depth of Field)", "é­šçœ¼é¡é ­ (Fisheye Lens)"]
            },
            {
                category: "ğŸŒŒ æ°›åœèˆ‡ç’°å¢ƒ (Atmosphere)",
                items: ["å²è©©æ„Ÿ (Epic)", "é»‘æš—å¥‡å¹» (Dark Fantasy)", "æº«é¦¨å¹³éœ (Cozy & Peaceful)", "æœªä¾†ç§‘æŠ€æ„Ÿ (Futuristic Sci-Fi)", "å»¢åœŸé¢¨æ ¼ (Post-Apocalyptic)"]
            }
        ];

        function initPromptHelper() {
            const container = document.getElementById('style-categories');
            styleData.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.innerHTML = `<div class="text-[#8b949e] text-xs font-semibold mb-2">${group.category}</div>`;
                const tagsDiv = document.createElement('div');
                tagsDiv.className = "flex flex-wrap gap-2";
                
                group.items.forEach(item => {
                    const tag = document.createElement('button');
                    tag.type = "button";
                    tag.className = "border border-[#30363d] bg-[#21262d] text-[#c9d1d9] hover:bg-[#30363d] hover:border-[#8b949e] transition-colors text-xs px-2.5 py-1 rounded-full text-left";
                    tag.innerText = item;
                    tag.onclick = () => appendPrompt(item);
                    tagsDiv.appendChild(tag);
                });
                groupDiv.appendChild(tagsDiv);
                container.appendChild(groupDiv);
            });
        }

        function togglePromptHelper() {
            const panel = document.getElementById('prompt-helper-panel');
            if(panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                panel.classList.add('flex');
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('flex');
            }
        }

        function appendPrompt(text) {
            const currentValue = input.value.trim();
            const prefix = currentValue ? ", " : "";
            input.value = currentValue + prefix + text;
            input.focus();
        }
        // --- é¢¨æ ¼æç¤ºè©å·¥å…·é‚è¼¯çµæŸ ---

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                modeSelect.value = "i2i";
                activeFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    thumbnail.src = e.target.result;
                    previewContainer.classList.remove('preview-hidden');
                    previewContainer.classList.add('preview-active');
                };
                reader.readAsDataURL(file);
            }
        });

        function clearUpload() {
            activeFile = null;
            fileInput.value = '';
            previewContainer.classList.remove('preview-active');
            previewContainer.classList.add('preview-hidden');
            modeSelect.value = "t2i";
        }

        function cancelGeneration() {
            if (currentAbortController) {
                currentAbortController.abort(); // ä¸­æ–· fetch è«‹æ±‚
            }
        }

        async function handleSend() {
            const text = input.value.trim();
            if (!text && !activeFile && !lastGeneratedImage) return; // å…è¨±åªæœ‰æ­·å²åœ–ç‰‡çš„æƒ…æ³
            
            // é—œé–‰å¯èƒ½é–‹è‘—çš„é¢¨æ ¼é¢æ¿
            document.getElementById('prompt-helper-panel').classList.add('hidden');
            document.getElementById('prompt-helper-panel').classList.remove('flex');

            const selectedQuality = document.querySelector('input[name="quality"]:checked').value;
            const targetModel = MODELS[modeSelect.value][selectedQuality];

            // æ™ºèƒ½è·¯ç”±ä¿®æ­£ï¼šç¢ºä¿æ¨¡å‹èƒ½å¤ æ­£ç¢ºä½¿ç”¨ç›¸æ‡‰çš„ API ç«¯é»
            let backendMode = modeSelect.value;
            if (targetModel.includes('nano-banana') || targetModel.includes('gemini')) {
                backendMode = 'i2i'; 
            }

            // æ§‹å»ºæ­·å²ç´€éŒ„ Payload
            let currentParts = [];
            if (text) currentParts.push({ text: text || "è«‹æ ¹æ“šåœ–ç‰‡é€²è¡Œä¿®æ”¹æˆ–æä¾›å»ºè­°ã€‚" });

            let userMsg = text;
            if (activeFile) {
                const base64Data = await toBase64(activeFile);
                const fileData = base64Data.split(',')[1];
                currentParts.push({ inlineData: { mimeType: activeFile.type, data: fileData } });
                userMsg = `[å·²é™„åŠ æ–°åœ–ç‰‡]\n\n${text}`;
                clearUpload();
            } else if (backendMode === 'i2i' && lastGeneratedImage) {
                // å¦‚æœæ˜¯åœ–ç”Ÿåœ–æ¨¡å¼ä¸”æ²’æœ‰ä¸Šå‚³æ–°åœ–ï¼Œè‡ªå‹•å°‡ä¸Šä¸€å¼µç”Ÿæˆçš„åœ–ç‰‡ä½œç‚ºåƒè€ƒåœ–
                currentParts.push({ inlineData: { mimeType: lastGeneratedMime, data: lastGeneratedImage } });
                userMsg = `[ä½¿ç”¨ä¸Šä¸€å¼µç”Ÿæˆçš„åœ–ç‰‡ä½œç‚ºåƒè€ƒ]\n\n${text}`;
            }

            addMessage('user', userMsg);
            input.value = '';

            // å­˜å…¥å‰ç«¯è¨˜æ†¶
            conversationHistory.push({ role: 'user', parts: currentParts });
            if (conversationHistory.length > MAX_HISTORY_LENGTH) {
                conversationHistory = conversationHistory.slice(conversationHistory.length - MAX_HISTORY_LENGTH);
            }

            const payload = { 
                message: text || "è«‹æ ¹æ“šé€™å¼µåœ–ç‰‡é€²è¡Œä¿®æ”¹æˆ–æä¾›å»ºè­°ã€‚", 
                mode: backendMode,
                quality: selectedQuality,
                model: targetModel,
                history: conversationHistory // å°‡å°è©±ç´€éŒ„é€çµ¦å¾Œç«¯
            };

            setLoading(true);
            
            // å¯¦ä¾‹åŒ–æ–°çš„ AbortController
            currentAbortController = new AbortController();
            
            try {
                let response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    signal: currentAbortController.signal // ç¶å®šä¸­æ–·ä¿¡è™Ÿ
                });
                
                let data = await response.json();
                
                // è‡ªå‹•å‚™æ´æ©Ÿåˆ¶ (Graceful Degradation)ï¼šæ””æˆª 503 ç­‰é«˜è² è¼‰éŒ¯èª¤ä¸¦é™ç´šé‡è©¦
                if (data.status !== "success" && data.error && (data.error.includes("503") || data.error.includes("high demand") || data.error.includes("UNAVAILABLE")) && selectedQuality === 'high') {
                    addMessage('ai', "âš ï¸ **è‡ªå‹•å‚™æ´å•Ÿå‹•**ï¼šå¤§å¸«æ¨¡å¼å¼•æ“ç›®å‰è™•æ–¼é«˜è² è¼‰ç‹€æ…‹ (503 High Demand)ã€‚ç³»çµ±å·²è§¸ç™¼å„ªé›…é™ç´šï¼Œæ­£è‡ªå‹•ç‚ºæ‚¨åˆ‡æ›è‡³ã€Œâš¡ è‰ç¨¿æ¨¡å¼ã€æ¥µé€Ÿå¼•æ“é‡æ–°ç”Ÿæˆï¼Œè«‹ç¨å€™...");
                    
                    // åˆ‡æ›ç‚º fast å‚™æ´æ¨¡å‹
                    const fallbackModel = MODELS[modeSelect.value]['fast'];
                    let fallbackBackendMode = modeSelect.value;
                    if (fallbackModel.includes('nano-banana') || fallbackModel.includes('gemini')) {
                        fallbackBackendMode = 'i2i'; 
                    }
                    
                    payload.quality = 'fast';
                    payload.model = fallbackModel;
                    payload.mode = fallbackBackendMode;
                    
                    // ç¬¬äºŒæ¬¡ Fetch (ä½¿ç”¨é™ç´šæ¨¡å‹é‡è©¦)
                    response = await fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        signal: currentAbortController.signal
                    });
                    data = await response.json();
                }
                
                if (data.status === "success") {
                    addMessage('ai', data.reply, { image: data.image, mime: data.mime });
                    
                    // å°‡ AI çš„å›æ‡‰å­˜å…¥è¨˜æ†¶
                    let aiParts = [];
                    if (data.reply) aiParts.push({ text: data.reply });
                    if (data.image) {
                        aiParts.push({ inlineData: { mimeType: data.mime, data: data.image } });
                        // æ›´æ–°æœ€å¾Œç”Ÿæˆçš„åœ–ç‰‡å¿«å–ï¼Œä¾›ä¸‹ä¸€æ¬¡è¿­ä»£ä½¿ç”¨
                        lastGeneratedImage = data.image;
                        lastGeneratedMime = data.mime;
                    }
                    if (aiParts.length > 0) {
                        conversationHistory.push({ role: 'model', parts: aiParts });
                    }
                } else { 
                    addMessage('ai', "ğŸš¨ éŒ¯èª¤: " + data.error); 
                    // è‹¥å¤±æ•—ï¼Œå°‡å‰›å‰›é€å‡ºçš„ user request å¾æ­·å²ä¸­ç§»é™¤ï¼Œé¿å…æ±¡æŸ“ä¸Šä¸‹æ–‡
                    conversationHistory.pop();
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // è‹¥æ˜¯ä½¿ç”¨è€…ä¸»å‹•ä¸­æ–·
                    addMessage('ai', "ğŸ›‘ å‹•ä½œå·²ç”±ä½¿ç”¨è€…å–æ¶ˆã€‚");
                } else {
                    addMessage('ai', "âŒ åŸ·è¡Œå¤±æ•—: " + error.message + "\n\n*(æç¤ºï¼šè«‹ç¢ºèªæ‚¨çš„ GAS éƒ¨ç½²è¨­å®šä¸­ï¼Œã€Œèª°å¯ä»¥å­˜å–ã€æ˜¯å¦å·²è¨­ç‚ºã€Œæ‰€æœ‰äººã€)*");
                }
                // è‹¥å¤±æ•—ï¼Œå°‡å‰›å‰›é€å‡ºçš„ user request å¾æ­·å²ä¸­ç§»é™¤
                if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'user') {
                    conversationHistory.pop();
                }
            } finally {
                setLoading(false);
            }
        }

        // æ¸²æŸ“ GitHub Timeline Issue ç•™è¨€é¢¨æ ¼
        function addMessage(role, text, meta = null) {
            const isUser = role === 'user';
            const author = isUser ? 'æ‚¨' : 'anyGem';
            const badge = !isUser ? '<span class="border border-[#30363d] text-[#8b949e] rounded-full px-2 py-[1px] text-[10px] ml-2 font-medium">bot</span>' : '';
            const avatarColor = isUser ? 'bg-[#238636]' : 'bg-[#8957e5]'; 
            const avatarInit = isUser ? 'U' : 'A';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const wrapper = document.createElement('div');
            wrapper.className = `flex gap-3 md:gap-4 animate-fade-in w-full max-w-4xl mx-auto`;
            
            let imgHTML = '';
            if (meta && meta.image) {
                imgHTML = `<img src="data:${meta.mime || 'image/png'};base64,${meta.image}" class="w-full max-w-2xl rounded-md mb-4 border border-[#30363d] cursor-pointer hover:opacity-90 transition-opacity" onclick="window.open(this.src, '_blank')">`;
            }

            let textHTML = '';
            if (text) {
                const formattedText = text.replace(/\n/g, '<br>');
                textHTML = `<div class="text-[14px] leading-[1.5] break-words text-[#c9d1d9]">${formattedText}</div>`;
            }

            wrapper.innerHTML = `
                <div class="flex-shrink-0 hidden md:block">
                    <div class="w-10 h-10 rounded-full ${avatarColor} flex items-center justify-center text-white font-bold text-lg shadow-sm">
                        ${avatarInit}
                    </div>
                </div>
                <div class="flex-grow min-w-0">
                    <div class="border border-[#30363d] rounded-md bg-[#0d1117] relative before:hidden md:before:block before:absolute before:right-[100%] before:top-4 before:border-8 before:border-transparent before:border-r-[#30363d] after:hidden md:after:block after:absolute after:right-[100%] after:top-[17px] after:border-[7px] after:border-transparent after:border-r-[#161b22]">
                        <div class="bg-[#161b22] border-b border-[#30363d] px-3 py-2 rounded-t-md text-sm flex items-center text-[#8b949e]">
                            <span class="font-semibold text-[#c9d1d9]">${author}</span> ${badge}
                            <span class="ml-2 hidden sm:inline">ç•™è¨€æ–¼ ${timeString}</span>
                        </div>
                        <div class="p-3 md:p-4">
                            ${imgHTML}
                            ${textHTML}
                        </div>
                    </div>
                </div>
            `;

            chatWindow.appendChild(wrapper); 
            
            setTimeout(() => {
                chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function setLoading(isLoading) { 
            if (isLoading) { 
                // è¼‰å…¥ä¸­ï¼šæŒ‰éˆ•è®Šæˆç´…è‰²ä¸¦å¸¶æœ‰ã€Œå–æ¶ˆã€åŠŸèƒ½
                btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>å–æ¶ˆ</span>`;
                btn.classList.replace('bg-[#238636]', 'bg-[#da3633]');
                btn.classList.replace('hover:bg-[#2ea043]', 'hover:bg-[#b62324]');
                btn.onclick = cancelGeneration;
            } else { 
                // æ¢å¾©åŸç‹€
                btn.innerHTML = '<span>ç”Ÿæˆ</span>';
                btn.classList.replace('bg-[#da3633]', 'bg-[#238636]');
                btn.classList.replace('hover:bg-[#b62324]', 'hover:bg-[#2ea043]');
                btn.onclick = handleSend;
                currentAbortController = null; // æ¸…é™¤æ§åˆ¶å™¨
            } 
        }
        
        function toBase64(file) { 
            return new Promise((resolve, reject) => { 
                const reader = new FileReader(); 
                reader.onload = () => resolve(reader.result); 
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file); 
            }); 
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            initPromptHelper(); // åˆå§‹åŒ–é¢¨æ ¼æç¤ºè©å·¥å…·
            setTimeout(() => {
                addMessage('ai', "æ­¡è¿ä¾†åˆ° **gem-studio/anyGem**ï¼ğŸš€\n\næˆ‘å·²ç¶“æº–å‚™å¥½ç‚ºæ‚¨ç”Ÿæˆæˆ–ç·¨è¼¯åœ–ç‰‡äº†ã€‚æ‚¨å¯ä»¥é»æ“Šä¸‹æ–¹å·¥å…·åˆ—çš„ **ğŸ·ï¸ æ¨™ç±¤æŒ‰éˆ•** ä¾†é¸æ“‡ç•«é¢¨èˆ‡å…‰å½±ï¼Œå¹«åŠ©æ‚¨æ›´ç²¾æº–åœ°ç”Ÿæˆåœ–ç‰‡ï¼");
            }, 500);
        };
    </script>
</body>
</html>
