<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>gem-studio/anyGem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeInUp 0.3s ease-out forwards; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; border: 2px solid #0d1117; }
        ::-webkit-scrollbar-thumb:hover { background: #8b949e; }
        
        .preview-active { display: flex; opacity: 1; padding: 0.5rem; border-bottom: 1px solid #30363d; }
        .preview-hidden { display: none; opacity: 0; }
        
        .engine-radio:checked + div {
            background-color: #21262d;
            border-color: #8b949e;
            color: #c9d1d9;
        }

        /* ç¥å™¨å°ˆå±¬ï¼šå®¢è£½åŒ–æ²å‹•è»¸ */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#0d1117] text-[#c9d1d9] h-screen flex flex-col overflow-hidden">

    <!-- GitHub Style Header -->
    <header class="bg-[#161b22] border-b border-[#21262d] py-3 px-4 flex flex-col md:flex-row md:items-center justify-between z-50 shadow-sm">
        <div class="flex items-center gap-2 mb-3 md:mb-0">
            <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" class="fill-[#c9d1d9]"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.46-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg>
            <div class="ml-2 text-lg">
                <span class="text-[#58a6ff] hover:underline cursor-pointer">gem-studio</span>
                <span class="text-[#8b949e] mx-1">/</span>
                <span class="text-[#c9d1d9] font-bold hover:underline cursor-pointer">anyGem</span>
            </div>
            <span class="border border-[#30363d] rounded-full px-2 py-0.5 text-[12px] text-[#8b949e] ml-2 font-medium">å…¬é–‹</span>
        </div>
        
        <div class="flex items-center gap-3">
            <select id="mode-select" class="bg-[#21262d] hover:bg-[#30363d] text-[#c9d1d9] text-sm py-1.5 px-3 rounded-md border border-[#30363d] outline-none font-medium cursor-pointer appearance-none pr-8 relative" style="background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23c9d1d9%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%0-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto;">
                <option value="t2i">ğŸ¨ æ–‡å­—ç”Ÿåœ–</option>
                <option value="i2i">ğŸ–¼ï¸ åœ–ç‰‡ç·¨è¼¯</option>
            </select>
            
            <div class="flex bg-[#0d1117] border border-[#30363d] rounded-md p-[2px]">
                <label class="cursor-pointer">
                    <input type="radio" name="quality" value="fast" class="engine-radio hidden" checked>
                    <div class="px-3 py-1 rounded-md text-xs font-medium text-[#8b949e] hover:text-[#c9d1d9] transition-colors">âš¡ è‰ç¨¿</div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="quality" value="high" class="engine-radio hidden">
                    <div class="px-3 py-1 rounded-md text-xs font-medium text-[#8b949e] hover:text-[#c9d1d9] transition-colors">ğŸ’ å¤§å¸«</div>
                </label>
            </div>
        </div>
    </header>

    <!-- Main Chat/Timeline Area -->
    <main id="chat-window" class="flex-grow p-4 md:p-6 overflow-y-auto space-y-6 scroll-smooth w-full"></main>

    <!-- ğŸª„ æç¤ºè©ç¥å™¨æ¨¡æ…‹è¦–çª— (God Mode Prompt Generator) -->
    <div id="god-prompt-modal" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#161b22] border border-[#30363d] rounded-xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden shadow-2xl animate-fade-in">
            <div class="p-4 border-b border-[#30363d] flex justify-between items-center bg-[#0d1117]">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="text-indigo-400">ğŸª„</span> æç¤ºè©ç¥å™¨ (Prompt Engine)
                </h2>
                <button onclick="closeGodModal()" class="text-[#8b949e] hover:text-white text-xl">âœ•</button>
            </div>
            
            <div class="flex flex-1 overflow-hidden">
                <!-- å·¦å´ï¼šåˆ†é¡é¸å–® -->
                <div id="god-sidebar" class="w-48 border-r border-[#30363d] bg-[#0d1117] overflow-y-auto custom-scrollbar"></div>
                <!-- å³å´ï¼šæ¨™ç±¤å€ -->
                <div id="god-content" class="flex-1 p-6 overflow-y-auto bg-[#0d1117] custom-scrollbar">
                    <div id="style-tags-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                </div>
            </div>

            <!-- ä¸‹æ–¹ï¼šé è¦½èˆ‡ç¢ºèª -->
            <div class="p-4 border-t border-[#30363d] bg-[#161b22] space-y-3">
                <div class="flex flex-col gap-2">
                    <div class="text-xs font-semibold text-indigo-400 uppercase tracking-widest">å·²é¸å–çš„æç¤ºè©åºåˆ—</div>
                    <div id="selected-tags-preview" class="bg-[#0d1117] border border-[#30363d] p-3 rounded-md text-sm font-mono min-h-[40px] text-indigo-100 flex flex-wrap gap-2"></div>
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-[10px] text-[#8b949e]">æç¤ºï¼šé»æ“Šæ¨™ç±¤å³å¯åŠ å…¥ï¼Œå†æ¬¡é»æ“Šç§»é™¤ã€‚</div>
                    <div class="flex gap-2">
                        <button onclick="clearSelectedTags()" class="px-4 py-2 text-sm text-red-400 hover:bg-red-900/20 rounded-md">æ¸…ç©ºå…¨éƒ¨</button>
                        <button onclick="applyGodPrompt()" class="bg-[#238636] hover:bg-[#2ea043] text-white px-6 py-2 rounded-md font-bold text-sm shadow-lg">å¥—ç”¨è‡³æ’°å¯«å€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Footer -->
    <footer class="p-4 bg-[#0d1117] border-t border-[#21262d] z-50">
        <div class="max-w-4xl mx-auto flex gap-3">
            <div class="hidden md:flex flex-shrink-0 mt-1">
                <div class="w-10 h-10 rounded-full bg-[#238636] flex items-center justify-center text-white font-bold text-lg shadow-sm">U</div>
            </div>
            
            <div class="flex-grow border border-[#30363d] rounded-md bg-[#0d1117] flex flex-col relative focus-within:border-[#58a6ff] focus-within:ring-1 focus-within:ring-[#58a6ff] transition-all">
                
                <div class="bg-[#161b22] border-b border-[#30363d] px-2 pt-2 flex gap-1 rounded-t-md">
                    <div class="px-4 py-2 text-[#c9d1d9] border border-[#30363d] border-b-transparent bg-[#0d1117] rounded-t-md text-sm font-medium -mb-px z-10">æ’°å¯«</div>
                </div>

                <!-- Preview Area -->
                <div id="upload-preview-container" class="preview-hidden bg-[#0d1117] items-center gap-3">
                    <div class="relative inline-block border border-[#30363d] rounded-md p-1 bg-[#161b22]">
                        <img id="upload-thumbnail" class="h-16 w-16 object-cover rounded-sm">
                        <button onclick="clearUpload()" class="absolute -top-2 -right-2 bg-[#da3633] text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hover:bg-[#b62324] shadow-md border border-[#0d1117]">âœ•</button>
                    </div>
                    <div class="text-xs text-[#8b949e]">
                        <span class="text-[#c9d1d9] font-medium">å·²é™„åŠ åœ–ç‰‡ã€‚</span> æ¨¡å¼è‡ªå‹•åˆ‡æ›ç‚º <span class="border border-[#30363d] rounded px-1 text-[#c9d1d9]">åœ–ç‰‡ç·¨è¼¯</span>ã€‚
                    </div>
                </div>

                <div class="p-2 bg-[#0d1117]">
                    <textarea id="user-input" class="w-full bg-[#0d1117] text-[#c9d1d9] outline-none resize-none p-2 min-h-[100px] text-sm placeholder-[#8b949e]" placeholder="ç•™è¨€æˆ–æè¿°æ‚¨æƒ³è¦çš„åœ–ç‰‡..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleSend(); }"></textarea>
                </div>

                <div class="flex justify-between items-center p-2 bg-[#161b22] rounded-b-md">
                    <div class="flex gap-1">
                        <input type="file" id="file-upload" class="hidden" accept="image/jpeg, image/png, image/webp">
                        <button onclick="document.getElementById('file-upload').click()" class="text-[#8b949e] hover:text-[#58a6ff] p-2 rounded-md transition-colors hover:bg-[#30363d]" title="é™„åŠ åœ–ç‰‡">
                            <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" class="fill-current"><path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5h-3.32Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path></svg>
                        </button>
                        <!-- ğŸª„ é–‹å•Ÿç¥å™¨æŒ‰éˆ• -->
                        <button onclick="openGodModal()" type="button" class="text-indigo-400 hover:text-indigo-300 p-2 rounded-md transition-colors hover:bg-[#30363d] flex items-center gap-1" title="æç¤ºè©ç¥å™¨">
                            <span class="text-sm font-bold">ğŸª„ ç¥å™¨</span>
                        </button>
                    </div>
                    
                    <button onclick="handleSend()" id="send-btn" class="bg-[#238636] hover:bg-[#2ea043] text-white px-4 py-1.5 rounded-md font-medium border border-[rgba(240,246,252,0.1)] text-sm transition-colors flex items-center gap-2">
                        <span>ç”Ÿæˆ</span>
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const chatWindow = document.getElementById('chat-window'), input = document.getElementById('user-input'), btn = document.getElementById('send-btn'), modeSelect = document.getElementById('mode-select'), fileInput = document.getElementById('file-upload'), previewContainer = document.getElementById('upload-preview-container'), thumbnail = document.getElementById('upload-thumbnail');
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyZ8ONPSxl0k5ZybOItosDbeCyb0P4Nb_xgcNlh3izSjrV-V11Y6lUMEkqs4JzZMjWhsg/exec";
        
        const MODELS = {
            t2i: { fast: "imagen-4.0-fast-generate-001", high: "imagen-4.0-ultra-generate-001" },
            i2i: { fast: "gemini-2.5-flash-image", high: "nano-banana-pro-preview" }
        };

        let activeFile = null, currentAbortController = null, conversationHistory = [], MAX_HISTORY_LENGTH = 10, lastGeneratedImage = null, lastGeneratedMime = null;

        // ==========================================
        // ğŸª„ ç¥å™¨æ•¸æ“šèˆ‡é‚è¼¯ (æ•´åˆè‡ª React ç‰ˆ)
        // ==========================================
        const STYLE_CATEGORIES = [
            { id: 'digital', title: 'æ•¸ä½èˆ‡ç¾ä»£è—è¡“', styles: [ { name: 'åƒç´ è—è¡“', en: 'Pixel Art', prompt: 'pixel art, 8-bit, low resolution' }, { name: 'æ‰å¹³åŒ–è¨­è¨ˆ', en: 'Flat Design', prompt: 'flat design, minimalist, bold colors, simple shapes' }, { name: 'å‘é‡æ’ç•«', en: 'Vector Illustration', prompt: 'vector illustration, clean lines, graphic design' }, { name: '3D æ¸²æŸ“', en: '3D Rendering', prompt: '3D render, cinematic lighting, Unreal Engine, Octane render' }, { name: 'ç­‰è·é€è¦–', en: 'Isometric 3D', prompt: 'isometric view, 3D isometric' } ] },
            { id: 'traditional', title: 'å‚³çµ±èˆ‡å¤å…¸è—è¡“', styles: [ { name: 'æ²¹ç•«', en: 'Oil Painting', prompt: 'oil painting, impasto, rich brushstrokes' }, { name: 'æ°´å½©ç•«', en: 'Watercolor', prompt: 'watercolor painting, soft washes' }, { name: 'é‰›ç­†ç´ æ', en: 'Pencil Sketch', prompt: 'pencil sketch, hand-drawn, line art' }, { name: 'å°è±¡æ´¾', en: 'Impressionism', prompt: 'impressionist painting' } ] },
            { id: 'popculture', title: 'æµè¡Œæ–‡åŒ–', styles: [ { name: 'å‹•æ¼«é¢¨æ ¼', en: 'Anime Style', prompt: 'anime illustration, clean line art' }, { name: 'è³½åšé¾å…‹', en: 'Cyberpunk', prompt: 'cyberpunk, neon-lit, futuristic city' }, { name: 'å¥‡å¹»è—è¡“', en: 'Fantasy Art', prompt: 'fantasy art, epic landscape' }, { name: 'å‰åœåŠ›', en: 'Studio Ghibli', prompt: 'Studio Ghibli style, whimsy' } ] },
            { id: 'photography', title: 'æ”å½±é¢¨æ ¼', styles: [ { name: 'å¯«å¯¦æ”å½±', en: 'Photorealism', prompt: 'photorealistic, ultra detailed, 8k' }, { name: 'å¾®è·æ”å½±', en: 'Macro Photo', prompt: 'macro photography, extreme close-up' }, { name: 'é»ƒé‡‘æ™‚åˆ»', en: 'Golden Hour', prompt: 'golden hour, warm tones' } ] },
            { id: 'camera', title: 'é¡é ­è¦–è§’', styles: [ { name: 'å»£è§’é¡é ­', en: 'Wide Angle', prompt: 'wide angle lens, expansive' }, { name: 'é³¥ç°è¦–è§’', en: 'Bird-Eye', prompt: 'birds-eye view, aerial photography' }, { name: 'æ™¯æ·±æ•£æ™¯', en: 'Bokeh', prompt: 'depth of field, bokeh, blurred background' } ] },
            { id: 'negatives', title: 'ğŸš« è² é¢æ’é™¤', styles: [ { name: 'é€šç”¨ç‘•ç–µ', en: 'Bad Quality', prompt: 'blurry, low quality, worst quality, text, watermark' }, { name: 'è‚¢é«”å´©å£', en: 'Bad Anatomy', prompt: 'ugly, deformed, extra limbs, bad hands' } ] }
        ];

        let selectedGodTags = [];

        function openGodModal() { document.getElementById('god-prompt-modal').classList.remove('hidden'); renderGodSidebar(); renderGodTags(STYLE_CATEGORIES[0].id); }
        function closeGodModal() { document.getElementById('god-prompt-modal').classList.add('hidden'); }

        function renderGodSidebar() {
            const sidebar = document.getElementById('god-sidebar');
            sidebar.innerHTML = STYLE_CATEGORIES.map(c => `
                <button onclick="renderGodTags('${c.id}')" class="w-full px-4 py-3 text-left text-sm font-medium transition-colors hover:bg-[#161b22] border-l-2 border-transparent focus:border-indigo-500 focus:bg-[#161b22]">${c.title}</button>
            `).join('');
        }

        function renderGodTags(categoryId) {
            const category = STYLE_CATEGORIES.find(c => c.id === categoryId);
            const grid = document.getElementById('style-tags-grid');
            grid.innerHTML = category.styles.map(s => `
                <button onclick="toggleGodTag('${s.prompt}')" class="p-3 border border-[#30363d] rounded-lg text-left hover:border-indigo-500 transition-all bg-[#161b22]">
                    <div class="text-sm font-bold">${s.name}</div>
                    <div class="text-[10px] text-[#8b949e] line-clamp-1">${s.en}</div>
                </button>
            `).join('');
        }

        function toggleGodTag(prompt) {
            if (selectedGodTags.includes(prompt)) { selectedGodTags = selectedGodTags.filter(t => t !== prompt); } 
            else { selectedGodTags.push(prompt); }
            updateTagPreview();
        }

        function updateTagPreview() {
            const preview = document.getElementById('selected-tags-preview');
            preview.innerHTML = selectedGodTags.map(t => `<span class="bg-indigo-900/40 border border-indigo-500/50 px-2 py-0.5 rounded-full text-xs animate-fade-in">${t}</span>`).join('');
        }

        function clearSelectedTags() { selectedGodTags = []; updateTagPreview(); }
        function applyGodPrompt() {
            const current = input.value.trim();
            const tagsStr = selectedGodTags.join(', ');
            input.value = current ? `${current}, ${tagsStr}` : tagsStr;
            closeGodModal();
            input.focus();
        }

        // ==========================================
        // æ ¸å¿ƒé€šè¨Šé‚è¼¯
        // ==========================================
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) { modeSelect.value = "i2i"; activeFile = file; const reader = new FileReader(); reader.onload = (e) => { thumbnail.src = e.target.result; previewContainer.classList.replace('preview-hidden', 'preview-active'); }; reader.readAsDataURL(file); }
        });

        function clearUpload() { activeFile = null; fileInput.value = ''; previewContainer.classList.replace('preview-active', 'preview-hidden'); modeSelect.value = "t2i"; }
        function cancelGeneration() { if (currentAbortController) currentAbortController.abort(); }

        async function handleSend() {
            const text = input.value.trim();
            if (!text && !activeFile && !lastGeneratedImage) return;

            const selectedQuality = document.querySelector('input[name="quality"]:checked').value;
            const targetModel = MODELS[modeSelect.value][selectedQuality];
            let backendMode = modeSelect.value;
            if (targetModel.includes('nano-banana') || targetModel.includes('gemini')) backendMode = 'i2i';

            let currentParts = [];
            if (text) currentParts.push({ text: text });

            let userMsg = text;
            if (activeFile) {
                const base64Data = await toBase64(activeFile);
                currentParts.push({ inlineData: { mimeType: activeFile.type, data: base64Data.split(',')[1] } });
                userMsg = `[å·²é™„åŠ åœ–ç‰‡]\n\n${text}`;
                clearUpload();
            } else if (backendMode === 'i2i' && lastGeneratedImage) {
                currentParts.push({ inlineData: { mimeType: lastGeneratedMime, data: lastGeneratedImage } });
                userMsg = `[è¿­ä»£ä¿®æ”¹]\n\n${text}`;
            }

            addMessage('user', userMsg);
            input.value = '';
            conversationHistory.push({ role: 'user', parts: currentParts });
            if (conversationHistory.length > MAX_HISTORY_LENGTH) conversationHistory.shift();

            setLoading(true);
            currentAbortController = new AbortController();

            try {
                const payload = { message: text, mode: backendMode, quality: selectedQuality, model: targetModel, history: conversationHistory };
                let response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), signal: currentAbortController.signal });
                let data = await response.json();

                if (data.status !== "success" && data.error && (data.error.includes("503") || data.error.includes("high demand"))) {
                    addMessage('ai', "âš ï¸ **å¤§å¸«å¼•æ“å¡è»Šä¸­**ï¼šè‡ªå‹•é™ç´šè‡³ã€Œâš¡ è‰ç¨¿æ¨¡å¼ã€æ¥µé€Ÿç”Ÿæˆä¸­...");
                    payload.quality = 'fast'; payload.model = MODELS[modeSelect.value]['fast']; payload.mode = (payload.model.includes('gemini') ? 'i2i' : 't2i');
                    response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), signal: currentAbortController.signal });
                    data = await response.json();
                }

                if (data.status === "success") {
                    addMessage('ai', data.reply, { image: data.image, mime: data.mime });
                    let aiParts = [];
                    if (data.reply) aiParts.push({ text: data.reply });
                    if (data.image) { aiParts.push({ inlineData: { mimeType: data.mime, data: data.image } }); lastGeneratedImage = data.image; lastGeneratedMime = data.mime; }
                    conversationHistory.push({ role: 'model', parts: aiParts });
                } else { addMessage('ai', "ğŸš¨ éŒ¯èª¤: " + data.error); conversationHistory.pop(); }
            } catch (error) {
                if (error.name === 'AbortError') addMessage('ai', "ğŸ›‘ å‹•ä½œå·²å–æ¶ˆã€‚");
                else addMessage('ai', "âŒ é€£ç·šå¤±æ•—ã€‚");
                conversationHistory.pop();
            } finally { setLoading(false); }
        }

        function addMessage(role, text, meta = null) {
            const isUser = role === 'user';
            const author = isUser ? 'æ‚¨' : 'anyGem', avatarColor = isUser ? 'bg-[#238636]' : 'bg-[#8957e5]';
            const now = new Date(), timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const wrapper = document.createElement('div');
            wrapper.className = `flex gap-3 md:gap-4 animate-fade-in w-full max-w-4xl mx-auto mb-6`;
            
            let imgHTML = meta && meta.image ? `<img src="data:${meta.mime || 'image/png'};base64,${meta.image}" class="w-full max-w-2xl rounded-md mb-4 border border-[#30363d] cursor-pointer hover:opacity-90" onclick="window.open(this.src, '_blank')">` : '';
            let textHTML = text ? `<div class="text-[14px] leading-[1.5] break-words text-[#c9d1d9]">${text.replace(/\n/g, '<br>')}</div>` : '';

            wrapper.innerHTML = `
                <div class="flex-shrink-0 hidden md:block">
                    <div class="w-10 h-10 rounded-full ${avatarColor} flex items-center justify-center text-white font-bold text-lg">${isUser ? 'U' : 'A'}</div>
                </div>
                <div class="flex-grow min-w-0">
                    <div class="border border-[#30363d] rounded-md bg-[#0d1117] relative">
                        <div class="bg-[#161b22] border-b border-[#30363d] px-3 py-2 rounded-t-md text-sm flex items-center text-[#8b949e]">
                            <span class="font-semibold text-[#c9d1d9]">${author}</span> ${!isUser ? '<span class="border border-[#30363d] text-[#8b949e] rounded-full px-2 py-[1px] text-[10px] ml-2 font-medium">bot</span>' : ''}
                            <span class="ml-2 hidden sm:inline">æ–¼ ${timeString}</span>
                        </div>
                        <div class="p-3 md:p-4">${imgHTML}${textHTML}</div>
                    </div>
                </div>`;
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
        }

        function setLoading(isLoading) { 
            if (isLoading) { btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> å–æ¶ˆ`; btn.classList.replace('bg-[#238636]', 'bg-[#da3633]'); btn.onclick = cancelGeneration; } 
            else { btn.innerHTML = 'ç”Ÿæˆ'; btn.classList.replace('bg-[#da3633]', 'bg-[#238636]'); btn.onclick = handleSend; } 
        }

        function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); }); }
        window.onload = () => { addMessage('ai', "æ­¡è¿ä¾†åˆ° **anyGem ç¹ªåœ–å¼•æ“**ï¼ğŸš€\n\nä½ å¯ä»¥ç›´æ¥è¼¸å…¥æç¤ºè©ï¼Œæˆ–è€…é»æ“Šä¸‹æ–¹å·¥å…·åˆ—çš„ **ğŸª„ ç¥å™¨** æŒ‰éˆ•ä¾†å¿«é€Ÿçµ„åˆå°ˆæ¥­çš„ç•«é¢¨æ¨™ç±¤ã€‚"); };
    </script>
</body>
</html>
